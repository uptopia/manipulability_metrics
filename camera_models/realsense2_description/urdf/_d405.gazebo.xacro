<?xml version="1.0"?>

<!--
License: Apache 2.0. See LICENSE file in root directory.
Copyright(c) 2017 Intel Corporation. All Rights Reserved

This is the URDF model for the Intel RealSense d405 camera
-->

<robot xmlns:xacro="http://ros.org/wiki/xacro">

  <xacro:macro name="gazebo_d405" params=" camera_name:=camera
                                           topics_ns:=camera
                                           reference_link

                                           depth_optical_frame
                                           depth_width:=1280
                                           depth_height:=780
                                           depth_fps:=60

                                           color_optical_frame
                                           color_width:=1280
                                           color_height:=800
                                           color_fps:=60
                                           visualize_color:=false

                                           infrared1_optical_frame
                                           infrared2_optical_frame
                                           infra_width:=1280
                                           infra_height:=720
                                           infra_fps:= 60

                                           enable_pointCloud:=false
                                           clip_distance:=0.1
                                           align_depth:=false
                                           ">


    <!-- The following values are approximate, and the camera node
     publishing TF values with actual calibrated camera extrinsic values -->
    <xacro:property name="d405_cam_depth_to_infra1_offset" value="0.009"/>
    <xacro:property name="d405_cam_depth_to_infra2_offset" value="-0.009"/>
    <xacro:property name="d405_cam_depth_to_color_offset" value="0.009"/>

    <xacro:property name="d405_cam_width" value="0.042"/>
    <xacro:property name="d405_cam_height" value="0.042"/>
    <xacro:property name="d405_cam_depth" value="0.023"/>
    <xacro:property name="d405_cam_mount_from_center_offset" value="0.00835"/>
    <xacro:property name="d405_cam_mount_from_front" value=".01465"/>

    <!-- The following offset is relative the  physical d405 camera peripheral
  	camera tripod mount -->
    <!-- Distance from mount to front glass, minus front glass to depth origin (via datasheet) -->
    <xacro:property name="d405_cam_depth_px" value="${d405_cam_mount_from_front - 0.0027}"/>
    <xacro:property name="d405_cam_depth_py" value="0"/>
    <xacro:property name="d405_cam_depth_pz" value="${d405_cam_height/2}"/>


    <!-- ***************************-->
    <!-- ****GAZEBO DEFINITIONS ****-->
    <!-- ***************************-->
    <xacro:property name="color_fps" value="60"/>
    <xacro:property name="infra_fps" value="60"/>
    <xacro:property name="depth_fps" value="60"/>

    <!-- See realsense datasheet-->
    <xacro:property name="color_fov" value="${radians(84)}"/>
    <xacro:property name="infra_fov" value="${radians(84)}"/>
    <xacro:property name="depth_fov" value="${radians(84)}"/>

    <!-- Camera image properties -->
    <xacro:property name="color_height" value="800"/>
    <xacro:property name="color_width" value="1280"/>
    <xacro:property name="infra_height" value="720"/>
    <xacro:property name="infra_width" value="1280"/>
    <xacro:property name="depth_height" value="720"/>
    <xacro:property name="depth_width" value="1280"/>
    
    <!-- clip_distance -->
    <xacro:property name="min_z" value="0.1"/>
    <xacro:property name="max_z" value="0.5"/>

    <!-- Load parameters to model's main link-->
    <gazebo reference="${camera_name}_link">
      <self_collide>0</self_collide>
      <enable_wind>0</enable_wind>
      <kinematic>0</kinematic>
      <gravity>true</gravity>
      <mu2>1</mu2>
      <fdir1>0 0 0</fdir1>

      <kp>1e+13</kp>
      <kd>1</kd>

      <!-- Color -->
      <sensor name="${camera_name}color" type="camera">
        <pose frame="">0 ${d405_cam_depth_to_color_offset} 0.0 0 0 0</pose>
        <camera name="${camera_name}">
          <horizontal_fov>${color_fov}</horizontal_fov>
          <image>
            <width>${color_width}</width>
            <height>${color_height}</height>
            <format>RGB_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.007</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <update_rate>${color_fps}</update_rate>
        <visualize>${visualize_color}</visualize>
      </sensor>
      <!-- InfarRed1:Left -->
      <sensor name="${camera_name}ired1" type="camera">
        <pose frame="">0 ${d405_cam_depth_to_infra1_offset} 0 0 0 0</pose>
        <camera name="${camera_name}">
          <horizontal_fov>${infra_fov}</horizontal_fov>
          <image>
            <width>${infra_width}</width>
            <height>${infra_height}</height>
            <format>L_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <update_rate>${infra_fps}</update_rate>
        <visualize>false</visualize>
      </sensor>
      <!-- InfarRed2:Right -->
      <sensor name="${camera_name}ired2" type="camera">
        <pose frame="">0 ${d405_cam_depth_to_infra2_offset} 0 0 0 0</pose>
        <camera name="${camera_name}">
          <horizontal_fov>${infra_fov}</horizontal_fov>
          <image>
            <width>${infra_width}</width>
            <height>${infra_height}</height>
            <format>L_INT8</format>
          </image>
          <clip>
            <near>0.1</near>
            <far>100</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <stddev>0.05</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <update_rate>${infra_fps}</update_rate>
        <visualize>false</visualize>
      </sensor>
      <!-- Depth -->
      <sensor name="${camera_name}depth" type="depth">
        <pose frame="">0 0 0 0 0 0</pose>
        <camera name="${camera_name}">
          <horizontal_fov>${depth_fov}</horizontal_fov>
          <image>
            <width>${depth_width}</width>
            <height>${depth_height}</height>
          </image>
          <clip>
            <near>${min_z}</near>
            <far>${max_z}</far>
          </clip>
          <noise>
            <type>gaussian</type>
            <mean>0.0</mean>
            <!-- based on https://doi.org/10.1109/URAI.2019.8768489 -->
            <stddev>0.043</stddev>
          </noise>
        </camera>
        <always_on>1</always_on>
        <xacro:unless value="${align_depth}">
          <update_rate>${depth_fps}</update_rate>
        </xacro:unless>
        <xacro:if value="${align_depth}">
          <update_rate>${color_fps}</update_rate>
        </xacro:if>
        <visualize>false</visualize>
      </sensor>
    </gazebo>

    <!-- Load plugin to the model ("robot" in urdf format)-->
    <gazebo>
      <plugin name="${topics_ns}" filename="librealsense_gazebo_plugin.so">
        <prefix>${camera_name}</prefix>

        <!-- Color camera settings -->
        <colorUpdateRate>${color_fps}</colorUpdateRate>      
        <colorTopicName>color/image_raw</colorTopicName>
        <colorOpticalframeName>${camera_name}_color_optical_frame</colorOpticalframeName>
        <colorCameraInfoTopicName>color/camera_info</colorCameraInfoTopicName>

        <!-- Infrared camera settings -->
        <infraredUpdateRate>${infra_fps}</infraredUpdateRate>
        <infrared1TopicName>infra1/image_raw</infrared1TopicName>
        <infrared2TopicName>infra2/image_raw</infrared2TopicName>
        <infrared1CameraInfoTopicName>infra1/camera_info</infrared1CameraInfoTopicName>
        <infrared2CameraInfoTopicName>infra2/camera_info</infrared2CameraInfoTopicName>
        <infrared1OpticalframeName>${camera_name}_infra1_optical_frame</infrared1OpticalframeName>
        <infrared2OpticalframeName>${camera_name}_infra2_optical_frame</infrared2OpticalframeName>

        <!-- Depth camera settings -->
        <depthUpdateRate>${depth_fps}</depthUpdateRate>
        <rangeMinDepth>0.2</rangeMinDepth>
        <rangeMaxDepth>10.0</rangeMaxDepth>
        <xacro:unless value="${align_depth}">
        	<depthUpdateRate>${depth_fps}</depthUpdateRate>
      	  <depthTopicName>depth/image_rect_raw</depthTopicName>
      	  <depthCameraInfoTopicName>depth/camera_info</depthCameraInfoTopicName>
        	<depthOpticalframeName>${depth_optical_frame}</depthOpticalframeName>
        </xacro:unless>
        <xacro:if value="${align_depth}">
        	<depthUpdateRate>${color_fps}</depthUpdateRate>
      	  <depthTopicName>aligned_depth_to_color/image_raw</depthTopicName>
      	  <depthCameraInfoTopicName>aligned_depth_to_color/camera_info</depthCameraInfoTopicName>
      	  <depthOpticalframeName>${color_optical_frame}</depthOpticalframeName>
        </xacro:if>
        <!-- <depthTopicName>depth/image_raw</depthTopicName>
        <depthCameraInfoTopicName>depth/camera_info</depthCameraInfoTopicName>
        <depthOpticalframeName>${camera_name}_depth_optical_frame</depthOpticalframeName> -->

        <!-- Pointlcloud settings -->
        <pointCloud>${enable_pointCloud}</pointCloud>
        <pointCloudTopicName>depth_registered/points</pointCloudTopicName>
        <!-- <pointCloudTopicName>depth/color/points</pointCloudTopicName> -->
        <!-- <pointCloudTopicName>/camera/depth_registered/points</pointCloudTopicName> -->
        <pointCloudCutoff>0.5</pointCloudCutoff>

      </plugin>
    </gazebo>
  </xacro:macro>
</robot>